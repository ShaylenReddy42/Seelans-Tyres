steps:
  - task: AzureCLI@2
    displayName: 'Deploy Prebuild Infrastructure'
    inputs:
      azureSubscription: 'Azure-Manual-SP'
      scriptType: ps
      scriptLocation: inlineScript
      inlineScript: az deployment sub create --template-file main.bicep --location 'southafricanorth'
      workingDirectory: '$(Build.SourcesDirectory)/infrastructure/with-bicep/01-prebuild'

  - task: AzureCLI@2
    name: containerRegistryProperties
    displayName: 'Set the Container Registry Variables'
    inputs:
      azureSubscription: 'Azure-Manual-SP'
      scriptType: ps
      scriptLocation: inlineScript
      inlineScript: |
        $containerRegistryName = $(az acr list --query "[?tags.intendedResourceName == 'cr-seelanstyres'] | [0].name" -o tsv)
        $containerRegistryLoginServer = $containerRegistryName + ".azurecr.io"
        Write-Host "##vso[task.setvariable variable=containerRegistryName;isOutput=true]$containerRegistryName"
        Write-Host "##vso[task.setvariable variable=containerRegistryLoginServer;isOutput=true]$containerRegistryLoginServer"
      workingDirectory: '$(Build.SourcesDirectory)/infrastructure/with-bicep/01-prebuild'

  - powershell: Write-Host "$(containerRegistryProperties.containerRegistryName) | $(containerRegistryProperties.containerRegistryLoginServer)"
    displayName:  'Verify the Container Registry Properties'